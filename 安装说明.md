# GAC Code 多平台状态栏插件 - 安装使用指南 (v2.0)

> **v2.0更新**: UUID系统优化、安全增强、统一启动器架构

## 📖 简介

GAC Code 多平台状态栏插件是一个功能强大的 Claude Code 扩展，支持多个 AI 平台的实时余额显示、优化的UUID会话映射和瞬时平台检测。

## ✨ v2.0 新特性

- ⚡ **O(1)平台检测**: 2位十六进制UUID前缀实现瞬时平台识别
- 🔒 **安全增强**: 敏感信息自动屏蔽、环境变量支持
- 🚀 **统一启动器**: Python主实现 + 轻量平台包装器
- 🔄 **会话管理**: 支持会话继续和状态保存
- 🎨 **优化调试**: 结构化日志和干运行模式

**支持的平台:**

- **GAC Code** - 官方平台
- **Kimi** - 月之暗面 (Moonshot)
- **DeepSeek** - 深度求索
- **SiliconFlow** - 硅流
- **Local Proxy** - 本地代理

## 🚀 快速安装

### 1. 前置依赖

**必需组件:**

- **Claude Code** - 已安装并可正常使用
- **Python 3.7+** - 必需，用于统一启动器系统和状态栏脚本
- **Git** - 用于下载项目 (可选，也可直接下载)

**Windows 额外要求:**

- PowerShell 5.1+ (通常已内置)

**Linux/Mac 额外要求:**

- bash shell (通常已内置)
- `jq` 工具 (推荐，用于 JSON 解析)

### 2. 下载项目

```bash
# 方法1: 使用 Git 克隆
git clone https://github.com/user/gaccode-statusline.git
cd gaccode-statusline

# 方法2: 直接下载解压
# 从 GitHub 下载 ZIP，解压到任意目录
```

### 3. 🔒 安全配置 API 密钥

**推荐方式1: 环境变量**（最安全）

```bash
# 设置环境变量
export DEEPSEEK_API_KEY="sk-your-actual-deepseek-key"
export KIMI_API_KEY="sk-your-actual-kimi-key"
export GAC_LOGIN_TOKEN="your-actual-gac-login-token"
export SILICONFLOW_API_KEY="sk-your-actual-sf-key"

# 注意：不建议在命令行中直接传递API密钥
# 推荐使用方式2直接编辑配置文件
# 如果使用环境变量，密钥会自动被检测
python platform_manager.py list  # 验证密钥配置状态

# 安全提醒：避免在shell历史中暴露API密钥
```

**方式2: 配置模板**（本地开发）

复制并编辑配置模板：

```bash
# 复制模板文件
cp examples/launcher-config.template.json examples/launcher-config.json

# 编辑配置文件
nano examples/launcher-config.json
```

将所有 `REPLACE-WITH-YOUR-ACTUAL-*` 占位符替换为真实API密钥：

```json
{
  "platforms": {
    "gaccode": {
      "name": "GAC Code",
      "api_base_url": "https://relay05.gaccode.com/claudecode",
      "api_key": "sk-ant-xxx", // 填入你的 GAC Code API Key
      "login_token": "eyJhbGci...", // 填入你的登录令牌
      "enabled": true // 设为 true 启用
    },
    "kimi": {
      "name": "Kimi",
      "api_base_url": "https://api.moonshot.cn/anthropic",
      "auth_token": "sk-xxx", // 填入你的 Kimi API Key
      "model": "kimi-k2-0905-preview",
      "enabled": true // 设为 true 启用
    },
    "deepseek": {
      "name": "DeepSeek",
      "api_base_url": "https://api.deepseek.com/anthropic",
      "api_key": "sk-xxx", // 填入你的 DeepSeek API Key
      "model": "deepseek-chat",
      "enabled": true // 设为 true 启用
    },
    "siliconflow": {
      "name": "SiliconFlow",
      "api_base_url": "https://api.siliconflow.cn/",
      "api_key": "sk-xxx", // 填入你的 SiliconFlow API Key
      "model": "deepseek-ai/DeepSeek-V3.1",
      "enabled": true // 设为 true 启用
    }
  },
  "settings": {
    "default_platform": "gaccode", // 默认平台
    "plugin_path": "../" // 插件路径，通常不需要修改
  }
}
```

### 4. 配置状态栏 (重要!)

将项目目录添加到 Claude Code 的状态栏配置中：

**在 Claude Code 中运行以下命令:**

```bash
# 配置状态栏显示
python /path/to/gaccode-statusline/config-statusline.py --interactive
```

**或者手动添加到 Claude Code 配置文件:**

```json
{
  "statusLine": {
    "type": "command",
    "command": "python /path/to/gaccode-statusline/statusline.py",
    "refreshInterval": 1000
  }
}
```

## 🎯 使用方法

### 🆕 统一启动器架构

**新特性**: 统一 Python 启动器取代了旧的双脚本系统
- **单一实现**: `launcher.py` 包含所有启动逻辑 (~300 行)
- **轻量级封装**: 平台特定脚本现在是简单的封装器 (30-40 行)
- **90% 维护量减少**: 从 2×400+ 行脚本到统一代码库
- **一致性行为**: 所有平台和操作系统上的功能完全相同
- **会话续接**: 支持 `--continue` 参数恢复之前的会话

### 直接 Python 启动器 (跨平台推荐)

```bash
# 进入项目目录
cd /path/to/gaccode-statusline

# 直接使用 Python 启动器 (所有功能)
python examples/launcher.py gc --continue           # 启动 GAC Code 并续接会话
python examples/launcher.py dp --continue           # 启动 DeepSeek 并续接会话
python examples/launcher.py kimi --continue         # 启动 Kimi 并续接会话
python examples/launcher.py sf --continue           # 启动 SiliconFlow 并续接会话

# 不指定平台 (使用默认平台)
python examples/launcher.py --continue

# 查看帮助和选项
python examples/launcher.py --help
python examples/launcher.py --list-platforms

# 测试模式 (不启动 Claude)
python examples/launcher.py dp --dry-run
```

### Windows 封装器 (PowerShell)

```powershell
# 进入项目目录
cd path\to\gaccode-statusline

# 启动不同平台 (使用别名) + 会话续接
.\examples\cc.mp.ps1 gc --continue           # 启动 GAC Code
.\examples\cc.mp.ps1 dp --continue           # 启动 DeepSeek
.\examples\cc.mp.ps1 kimi --continue         # 启动 Kimi
.\examples\cc.mp.ps1 sf --continue           # 启动 SiliconFlow

# 使用完整平台名
.\examples\cc.mp.ps1 gaccode --continue      # 启动 GAC Code
.\examples\cc.mp.ps1 deepseek --continue     # 启动 DeepSeek

# 不指定平台 (使用默认平台)
.\examples\cc.mp.ps1 --continue

# 传递额外参数给 Claude Code
.\examples\cc.mp.ps1 dp --help
.\examples\cc.mp.ps1 kimi --version
```

### Linux/Mac 封装器 (Bash)

```bash
# 进入项目目录
cd /path/to/gaccode-statusline

# 给脚本添加执行权限
chmod +x examples/cc.mp.sh

# 启动不同平台 (使用别名) + 会话续接
./examples/cc.mp.sh gc --continue            # 启动 GAC Code
./examples/cc.mp.sh dp --continue            # 启动 DeepSeek
./examples/cc.mp.sh kimi --continue          # 启动 Kimi
./examples/cc.mp.sh sf --continue            # 启动 SiliconFlow

# 使用完整平台名
./examples/cc.mp.sh gaccode --continue       # 启动 GAC Code
./examples/cc.mp.sh deepseek --continue      # 启动 DeepSeek

# 不指定平台 (使用默认平台)
./examples/cc.mp.sh --continue

# 传递额外参数给 Claude Code
./examples/cc.mp.sh dp --help
./examples/cc.mp.sh kimi --version
```

### Windows 批处理封装器 (新增)

```cmd
# 进入项目目录
cd path\to\gaccode-statusline

# 启动不同平台 + 会话续接
examples\cc.mp.bat gc --continue             # 启动 GAC Code
examples\cc.mp.bat dp --continue             # 启动 DeepSeek
examples\cc.mp.bat kimi --continue           # 启动 Kimi
examples\cc.mp.bat sf --continue             # 启动 SiliconFlow
```

## 🔧 高级配置

### 平台别名

在 `launcher-config.json` 中可以自定义平台别名：

```json
{
  "aliases": {
    "gc": "gaccode", // gc → gaccode
    "dp": "deepseek", // dp → deepseek
    "ds": "deepseek", // ds → deepseek
    "sf": "siliconflow", // sf → siliconflow
    "kimi": "kimi", // kimi → kimi
    "my": "gaccode" // 自定义别名
  }
}
```

### 状态栏显示配置

```bash
# 交互式配置状态栏显示选项
python config-statusline.py --interactive

# 查看当前配置
python config-statusline.py --show

# 设置特定选项
python config-statusline.py --set show_git_branch true
python config-statusline.py --set layout multi_line
```

### 平台密钥管理

```bash
# 查看平台密钥配置状态（安全 - 不会暴露密钥）
python platform_manager.py get-key deepseek
python platform_manager.py get-key kimi
python platform_manager.py get-key siliconflow

# 安全提醒：请通过编辑 examples/launcher-config.json 文件配置API密钥
# 避免在命令行中直接传递密钥，防止在shell历史中暴露

# 查看平台状态
python platform_manager.py list

# 获取特定平台密钥
python platform_manager.py get-key gaccode
```

## 📊 状态栏显示说明

启动后，Claude Code 状态栏会显示：

```
Model:Claude 3.5 Sonnet Time:14:30:45 Today:$89.50 GAC.B:1500/12000 (35m12s) Dir:~/project
```

**显示元素解释:**

- `Model`: 当前使用的 AI 模型
- `Time`: 当前时间
- `Today`: 今日消费金额 (如果有使用量追踪)
- `GAC.B:1500/12000`: GAC Code 余额/总容量
  - 红色 ≤ 500: 余额不足
  - 黄色 ≤ 1000: 余额较低
  - 绿色 > 1000: 余额充足
- `(35m12s)`: 下次余额刷新倒计时
- `Dir`: 当前工作目录

## 🛠️ 故障排除

### 常见问题

**1. 状态栏不显示余额信息**

```bash
# 检查平台检测是否正常
python statusline.py
# 输入测试数据: {"session_id":"test-uuid","model":{"display_name":"Test"}}

# 检查会话映射文件
cat data/cache/session-mappings.json

# 查看日志
tail -f data/logs/statusline.log
```

**2. 平台检测失败**

- 确保使用启动器接口 (`launcher.py`、`cc.mp.ps1`、`cc.mp.sh`、或 `cc.mp.bat`) 而不是直接运行 `claude`
- 检查 Python 3.7+ 是否可用 (统一启动器系统必需)
- 测试直接启动器: `python examples/launcher.py dp --dry-run`
- 检查 API 密钥是否正确配置
- 验证网络连接

**3. API 调用失败**

```bash
# 测试特定平台 API 连接
python -c "
from platforms.gaccode import GACCodePlatform
import json
with open('data/config/launcher-config.json', 'r', encoding='utf-8-sig') as f:
    config = json.load(f)
platform = GACCodePlatform(config['platforms']['gaccode']['api_key'], config['platforms']['gaccode'])
print(platform.fetch_balance_data())
"
```

**4. 权限错误 (Linux/Mac)**

```bash
# 给脚本添加执行权限
chmod +x examples/cc.mp.sh
chmod +x *.py
```

### 调试模式

```bash
# 查看详细日志
tail -f data/logs/platform-manager.log
tail -f data/logs/statusline.log

# 测试平台管理器
python platform_manager.py list --debug

# 手动测试状态栏
echo '{"session_id":"test","model":{"display_name":"Test"}}' | python statusline.py
```

## 📝 文件结构 (更新后的架构)

```
gaccode-statusline/
├── examples/                   # 统一启动器系统
│   ├── launcher.py            # 🆕 统一 Python 启动器 (主实现, ~300行)
│   ├── cc.mp.ps1              # ✅ 轻量级 PowerShell 封装器 (~30行)
│   ├── cc.mp.sh               # ✅ 轻量级 Bash 封装器 (~30行)
│   ├── cc.mp.bat              # 🆕 Windows 批处理封装器 (~30行)
│   └── launcher-config.json   # 平台配置文件
├── platforms/                 # 平台实现
│   ├── base.py               # 基础平台类
│   ├── gaccode.py            # GAC Code 平台
│   ├── kimi.py               # Kimi 平台
│   ├── deepseek.py           # DeepSeek 平台
│   └── siliconflow.py        # SiliconFlow 平台
├── data/
│   ├── session_manager.py    # 🆕 会话状态管理
│   ├── config/               # 运行时配置
│   ├── cache/                # 缓存文件
│   └── logs/                 # 日志文件
├── statusline.py             # 主状态栏脚本
├── platform_manager.py      # 平台管理工具
├── config-statusline.py     # 状态栏配置工具
└── 安装说明.md              # 本文档
```

### 架构改进

**旧系统** (维护困难):
- `cc.mp.ps1`: 400+ 行 PowerShell 逻辑
- `cc.mp.sh`: 400+ 行 Bash 逻辑
- 重复功能，平台特定错误

**新系统** (统一且可维护):
- `launcher.py`: ~300 行统一 Python 逻辑
- `cc.mp.ps1`: ~30 行 PowerShell 封装器
- `cc.mp.sh`: ~30 行 Bash 封装器
- `cc.mp.bat`: ~30 行批处理封装器
- 单一数据源，一致行为

## 🤝 支持与反馈

如遇到问题，请：

1. 查看日志文件 (`data/logs/`)
2. 运行诊断命令验证配置
3. 检查 API 密钥和网络连接
4. 确保使用正确的启动脚本

享受多平台 Claude Code 体验！ 🎉
